<!DOCTYPE html>
<html>
<head>
    <title>Community Hub</title>
    <style>
        body { font-family: sans-serif; padding: 30px; max-width: 800px; margin: auto; line-height: 1.6; background: #f9f9f9; }
        .header { border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; background: white; padding: 20px; border-radius: 8px; }
        .card { border: 1px solid #e1e4e8; padding: 20px; border-radius: 8px; margin-bottom: 15px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn-main { background: #2ea44f; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold; display: inline-block; margin-top: 10px; }
        .suggest-btn { float: right; font-size: 0.85em; color: #0969da; text-decoration: none; border: 1px solid #d1d5da; padding: 6px 12px; border-radius: 4px; transition: 0.2s; }
        .suggest-btn:hover { background: #f6f8fa; }
    </style>

    <div id="editor-modal" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:white; border:2px solid #000; padding:20px; z-index:1000;">
    <h3>Edit Cluster Information</h3>
    <input type="text" id="edit-title" style="width:100%"><br><br>
    <textarea id="edit-body" style="width:100%; height:300px;"></textarea><br><br>
    <button onclick="submitPR()" class="btn-main">Submit for Review</button>
    <button onclick="document.getElementById('editor-modal').style.display='none'">Cancel</button>
</div>

<script>
async function openEditor(filename, currentTitle) {
    // 1. Show the modal
    document.getElementById('editor-modal').style.display = 'block';
    document.getElementById('edit-title').value = currentTitle;
    
    // 2. Fetch current content to edit
    const res = await fetch(`https://raw.githubusercontent.com/${USER}/${REPO}/master/clusters/${filename}`);
    const text = await res.text();
    document.getElementById('edit-body').value = text;
    window.currentEditingFile = filename;
}

async function submitPR() {
    const newContent = document.getElementById('edit-body').value;
    const filename = window.currentEditingFile;

    // This sends a 'repository_dispatch' event to GitHub Actions
    // NOTE: This requires a small 'Proxy' or a GitHub Token to be secure.
    alert("In a public app, we now trigger a GitHub Action to create your PR branch!");
    
    // We will use a GitHub Action to handle the 'Write' part
    // so the user never leaves this page.
}
</script>
    
</head>
<body>
    <div class="header">
        <h1>üè° Community Source of Truth</h1>
        <p>Public directory. No login required to view data.</p>
        <a href="https://github.com/dekumar2-lab/community-hub/issues/new?title=New+Area+Proposal&body=Please+provide+details+for+the+new+cluster." class="btn-main">+ Propose New Area</a>
    </div>

    <div id="directory">Loading available clusters...</div>

    <script>
        const USER = 'dekumar2-lab';
        const REPO = 'community-hub';

        async function fetchClusters() {
            const container = document.getElementById('directory');
            try {
                // This fetches the files inside your 'clusters' folder
                const response = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/clusters`);
                const files = await response.json();
                
                if (!Array.isArray(files)) throw new Error("Folder not found");

                container.innerHTML = '';
                files.forEach(file => {
                    if (file.name.endsWith('.md')) {
                        const displayName = file.name.replace('.md', '').replace(/-/g, ' ').toUpperCase();
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.innerHTML = `
                            <a href="https://github.com/${USER}/${REPO}/issues/new?title=Update+Request:+${file.name}&body=I+suggest+the+following+changes+to+${displayName}:" class="suggest-btn">Suggest Edit</a>
                            <h3>${displayName}</h3>
                            <p>Official information for this residential sector.</p>
                        `;
                        container.appendChild(card);
                    }
                });
            } catch (e) {
                container.innerHTML = "<p style='color:red;'>Error: Could not find any data in the 'clusters' folder. Make sure you have .md files there!</p>";
            }
        }
        fetchClusters();
    </script>
</body>
</html>
